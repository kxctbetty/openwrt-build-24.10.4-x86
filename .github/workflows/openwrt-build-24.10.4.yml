name: Build openwrt-24.10.4 for x86_64

on:
  workflow_dispatch:  # 仅手动触发编译

env:
  # 源码配置（适配v24.10.4官方Tag）
  SOURCE_URL: https://github.com/openwrt/openwrt.git
  SOURCE_BRANCH: v24.10.4
  CLONE_DEPTH: 1
  # 文件路径配置
  CONFIG_FILE: configs/for_openwrt2410.4/x86_64.config
  DIY_SH: scripts/diy.sh
  FIX_SH: scripts/fix.sh
  FEEDS_SH: scripts/feeds.sh
  # Release配置
  IMAGE_TAG: firmware-x86_64-openwrt-24.10.4
  IMAGE_NAME: Firmware-x86_64-openwrt-24.10.4
  TOOLCHAIN_TAG: toolchain-x86_64-openwrt-24.10.4
  TOOLCHAIN_NAME: Toolchain-x86_64-openwrt-24.10.4
  # 开关配置
  TOOLCHAIN_RELEASE_UPLOAD: true
  FIRMWARE_RELEASE_UPLOAD: true
  COMBINE_DISK: true
  # 缓存配置
  TZ: Asia/Shanghai
  CCACHE_DIR: /home/runner/.ccache
  CCACHE_SIZE: 50G

jobs:
  # 阶段1：编译工具链（适配v24.10.4）
  Toolchain:
    runs-on: ubuntu-22.04
    outputs:
      OPENWRT_ROOT_PATH: ${{ steps.clone.outputs.OPENWRT_ROOT_PATH }}
      TOOLCHAIN_OUTPUT: ${{ steps.clone.outputs.TOOLCHAIN_OUTPUT }}
      CURRENT_BRANCH: ${{ steps.env.outputs.CURRENT_BRANCH }}
      SOURCE_OWNER: ${{ steps.env.outputs.SOURCE_OWNER }}
      SOURCE_REPO: ${{ steps.env.outputs.SOURCE_REPO }}
      DEVICE_PLATFORM: ${{ steps.env.outputs.DEVICE_PLATFORM }}
      DEVICE_TARGET: ${{ steps.env.outputs.DEVICE_TARGET }}
      DEVICE_SUBTARGET: ${{ steps.env.outputs.DEVICE_SUBTARGET }}
      TOOLCHAIN_IMAGE: ${{ steps.env.outputs.TOOLCHAIN_IMAGE }}
      BUILD_DATE: ${{ steps.env.outputs.BUILD_DATE }}

    steps:
      - name: 初始化Git配置
        run: |
          git config --global init.defaultBranch main
          git config --global advice.detachedHead false

      - name: 拉取仓库配置文件
        uses: actions/checkout@v5  # 无多余token参数，避免报错

      - name: 清理磁盘空间
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get -qq update
          sudo -E apt-get -qq -y purge ghc* zulu* google* dotnet* mysql* php apache2 azure-cli firefox powershell
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get -y clean
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          docker image prune -a -f

      - name: 安装编译依赖（适配v24.10.4）
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get -qq -y upgrade
          sudo -E apt-get -y install \
          autoconf automake bash bc bison binutils bzip2 cmake coreutils curl diffutils flex \
          g++ gcc gettext git gzip libc6-dev libelf-dev libffi-dev libgmp-dev liblzma-dev \
          libncurses-dev libncursesw5-dev libpcre3-dev libreadline-dev libssl-dev libtool \
          libudev-dev libxml2-dev llvm lzop make patch perl pkg-config python3 \
          python3-distutils python3-setuptools rsync sed subversion tar unzip wget xz-utils \
          zlib1g-dev libclang-dev clang ninja-build ccache
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get -y clean
          sudo ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
          mkdir -p $CCACHE_DIR
          chmod 777 $CCACHE_DIR

      - name: 克隆OpenWRT v24.10.4源码
        id: clone
        run: |
          mkdir -p openwrt
          cd openwrt
          git clone --depth $CLONE_DEPTH --single-branch -b $SOURCE_BRANCH $SOURCE_URL .
          echo "OPENWRT_ROOT_PATH=$(pwd)" >> $GITHUB_OUTPUT
          echo "TOOLCHAIN_OUTPUT=$(pwd)/output" >> $GITHUB_OUTPUT
          echo "CURRENT_BRANCH=$SOURCE_BRANCH" >> $GITHUB_OUTPUT
          echo "SOURCE_OWNER=$(echo $SOURCE_URL | awk -F '/' '{print $(NF-2)}')" >> $GITHUB_OUTPUT
          echo "SOURCE_REPO=$(echo $SOURCE_URL | awk -F '/' '{print $(NF-1)}')" >> $GITHUB_OUTPUT
          echo "DEVICE_PLATFORM=x86" >> $GITHUB_OUTPUT
          echo "DEVICE_TARGET=x86" >> $GITHUB_OUTPUT
          echo "DEVICE_SUBTARGET=64" >> $GITHUB_OUTPUT
          echo "TOOLCHAIN_IMAGE=openwrt-toolchain-x86_64-24.10.4" >> $GITHUB_OUTPUT
          echo "BUILD_DATE=$(date +%Y%m%d)" >> $GITHUB_OUTPUT

      - name: 执行Feeds配置脚本（适配v24.10.4+kenzok8）
        run: |
          cd ${{ steps.clone.outputs.OPENWRT_ROOT_PATH }}
          chmod +x $GITHUB_WORKSPACE/$FEEDS_SH
          $GITHUB_WORKSPACE/$FEEDS_SH

      - name: 配置编译参数（适配x86_64）
        run: |
          cd ${{ steps.clone.outputs.OPENWRT_ROOT_PATH }}
          echo "CONFIG_TARGET_x86=y" >> .config
          echo "CONFIG_TARGET_x86_64=y" >> .config
          echo "CONFIG_TARGET_x86_64_Generic=y" >> .config
          echo "CONFIG_CCACHE=y" >> .config
          echo "CONFIG_CCACHE_SIZE=$CCACHE_SIZE" >> .config
          make defconfig

      - name: 编译工具链
        run: |
          cd ${{ steps.clone.outputs.OPENWRT_ROOT_PATH }}
          make toolchain/install -j$(nproc)
          mkdir -p ${{ steps.clone.outputs.TOOLCHAIN_OUTPUT }}
          cp -rf staging_dir/toolchain-x86_64_gcc* ${{ steps.clone.outputs.TOOLCHAIN_OUTPUT }}/

      - name: 生成工具链镜像
        if: env.TOOLCHAIN_RELEASE_UPLOAD == 'true'
        run: |
          cd ${{ steps.clone.outputs.OPENWRT_ROOT_PATH }}
          mkdir -p ${{ steps.clone.outputs.TOOLCHAIN_OUTPUT }}
          tar -zcf ${{ steps.clone.outputs.TOOLCHAIN_OUTPUT }}/${{ env.TOOLCHAIN_IMAGE }}.tar.gz staging_dir/toolchain-x86_64_gcc*
          echo "TOOLCHAIN_HASH=$(sha256sum ${{ steps.clone.outputs.TOOLCHAIN_OUTPUT }}/${{ env.TOOLCHAIN_IMAGE }}.tar.gz | awk '{print $1}')" >> $GITHUB_ENV
          echo ${{ env.TOOLCHAIN_HASH }} > ${{ steps.clone.outputs.TOOLCHAIN_OUTPUT }}/${{ env.TOOLCHAIN_IMAGE }}.hash

      - name: 删除旧工具链Release
        if: env.TOOLCHAIN_RELEASE_UPLOAD == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}  # 仅Release操作用GH_PAT
        run: |
          assets=$(gh release view "${{ env.TOOLCHAIN_TAG }}" --json assets --jq '.assets[].name' 2>/dev/null || true)
          if [ -n "$assets" ]; then
            for asset in $assets; do
              gh release delete-asset "${{ env.TOOLCHAIN_TAG }}" "$asset" --yes
            done
            gh release delete "${{ env.TOOLCHAIN_TAG }}" --cleanup-tag --yes 2>/dev/null || true
          fi

      - name: 上传工具链到Release
        if: env.TOOLCHAIN_RELEASE_UPLOAD == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          cd ${{ steps.clone.outputs.TOOLCHAIN_OUTPUT }}
          gh release create "${{ env.TOOLCHAIN_TAG }}" \
            --title "${{ env.TOOLCHAIN_NAME }}" \
            --notes "OpenWRT v24.10.4 x86_64 工具链 | 编译日期：${{ env.BUILD_DATE }}" \
            *.tar.gz *.hash

  # 阶段2：编译固件（依赖工具链，适配v24.10.4）
  Build:
    needs: Toolchain
    runs-on: ubuntu-22.04
    steps:
      - name: 初始化环境
        run: |
          git config --global init.defaultBranch main
          git config --global advice.detachedHead false
          sudo ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

      - name: 拉取仓库配置
        run: |
          mkdir -p $GITHUB_WORKSPACE/configs
          git init
          git remote add origin https://github.com/${{ github.repository }}
          git fetch --depth 1 origin ${{ github.ref }}
          git checkout -t origin/${{ github.ref_name }}

      - name: 清理磁盘空间
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get -qq update
          sudo -E apt-get -qq -y purge ghc* zulu* google* dotnet* mysql* php apache2 azure-cli firefox powershell
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get -y clean
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          docker image prune -a -f

      - name: 安装编译依赖
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get -qq -y upgrade
          sudo -E apt-get -y install \
          autoconf automake bash bc bison binutils bzip2 cmake coreutils curl diffutils flex \
          g++ gcc gettext git gzip libc6-dev libelf-dev libffi-dev libgmp-dev liblzma-dev \
          libncurses-dev libncursesw5-dev libpcre3-dev libreadline-dev libssl-dev libtool \
          libudev-dev libxml2-dev llvm lzop make patch perl pkg-config python3 \
          python3-distutils python3-setuptools rsync sed subversion tar unzip wget xz-utils \
          zlib1g-dev libclang-dev clang ninja-build ccache
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get -y clean

      - name: 克隆OpenWRT v24.10.4源码
        run: |
          mkdir -p openwrt
          cd openwrt
          git clone --depth ${{ env.CLONE_DEPTH }} --single-branch -b ${{ env.SOURCE_BRANCH }} ${{ env.SOURCE_URL }} .
          echo "OPENWRT_ROOT_PATH=$(pwd)" >> $GITHUB_ENV

      - name: 缓存下载的包源码（修复hashFiles路径，用scripts/feeds.sh）
        uses: actions/cache@v4
        with:
          path: ${{ env.OPENWRT_ROOT_PATH }}/dl
          key: ${{ runner.os }}-openwrt-dl-24.10.4-${{ hashFiles('scripts/feeds.sh') }}  # 核心修复点
          restore-keys: |
            ${{ runner.os }}-openwrt-dl-24.10.4-
            ${{ runner.os }}-openwrt-dl-

      - name: 执行Feeds配置脚本
        run: |
          cd ${{ env.OPENWRT_ROOT_PATH }}
          chmod +x $GITHUB_WORKSPACE/${{ env.FEEDS_SH }}
          $GITHUB_WORKSPACE/${{ env.FEEDS_SH }}

      - name: 加载自定义配置
        run: |
          cd ${{ env.OPENWRT_ROOT_PATH }}
          if [ -f "$GITHUB_WORKSPACE/${{ env.CONFIG_FILE }}" ]; then
            cp -f "$GITHUB_WORKSPACE/${{ env.CONFIG_FILE }}" .config
          else
            echo "CONFIG_TARGET_x86=y" >> .config
            echo "CONFIG_TARGET_x86_64=y" >> .config
            echo "CONFIG_TARGET_x86_64_Generic=y" >> .config
            echo "CONFIG_CCACHE=y" >> .config
            echo "CONFIG_CCACHE_SIZE=${{ env.CCACHE_SIZE }}" >> .config
            make defconfig
          fi

      - name: 编译固件
        run: |
          cd ${{ env.OPENWRT_ROOT_PATH }}
          make download -j$(nproc)
          make -j$(nproc) || make -j1 V=s  # 编译失败时单线程输出详细日志

      - name: 整理固件文件
        run: |
          cd ${{ env.OPENWRT_ROOT_PATH }}
          mkdir -p $GITHUB_WORKSPACE/firmware
          cp -rf bin/targets/x86/64/*.bin $GITHUB_WORKSPACE/firmware/
          cp -rf bin/targets/x86/64/*.img $GITHUB_WORKSPACE/firmware/
          cp -rf bin/targets/x86/64/*.tar.gz $GITHUB_WORKSPACE/firmware/
          sha256sum $GITHUB_WORKSPACE/firmware/* > $GITHUB_WORKSPACE/firmware/sha256sum.txt

      - name: 上传固件到Artifact（备用下载）
        uses: actions/upload-artifact@v5
        with:
          name: ${{ env.IMAGE_NAME }}
          path: $GITHUB_WORKSPACE/firmware/

  # 阶段3：上传固件到Release
  Upload:
    needs: Build
    runs-on: ubuntu-22.04
    steps:
      - name: 拉取仓库文件
        uses: actions/checkout@v5  # 无多余token参数

      - name: 下载固件Artifact
        uses: actions/download-artifact@v6
        with:
          name: ${{ env.IMAGE_NAME }}
          path: $GITHUB_WORKSPACE/firmware

      - name: 删除旧固件Release
        if: env.FIRMWARE_RELEASE_UPLOAD == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          assets=$(gh release view "${{ env.IMAGE_TAG }}" --json assets --jq '.assets[].name' 2>/dev/null || true)
          if [ -n "$assets" ]; then
            for asset in $assets; do
              gh release delete-asset "${{ env.IMAGE_TAG }}" "$asset" --yes
            done
            gh release delete "${{ env.IMAGE_TAG }}" --cleanup-tag --yes 2>/dev/null || true
          fi

      - name: 上传固件到Release
        if: env.FIRMWARE_RELEASE_UPLOAD == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          cd $GITHUB_WORKSPACE/firmware
          gh release create "${{ env.IMAGE_TAG }}" \
            --title "${{ env.IMAGE_NAME }}" \
            --notes "OpenWRT v24.10.4 x86_64 固件 | 含Passwall2/IKoolProxy/Argon | 编译日期：${{ env.BUILD_DATE }}" \
            *
