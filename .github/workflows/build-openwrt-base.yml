name: Build OpenWrt 24.10.4 Base (x86_64 软路由)

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build-openwrt-base.yml'
      - 'configs_for_openwrt24104/base.config'
  workflow_dispatch:  # 支持手动触发编译

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 安装编译依赖
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget

      - name: 拉取OpenWrt 24.10.4源码（稳定版）
        run: |
          git clone --depth 1 --branch v24.10.4 https://github.com/openwrt/openwrt.git openwrt
          cd openwrt
          # 替换国内源加速下载（可选，提升编译速度）
          sed -i 's/downloads.openwrt.org/mirrors.cloud.tencent.com\/openwrt/g' ./feeds.conf.default

      - name: 导入基础配置文件
        run: |
          cp configs_for_openwrt24104/base.config openwrt/.config
          cd openwrt
          make defconfig  # 自动补全配置依赖，避免遗漏

      - name: 缓存编译环境（供二次编译复用）
        uses: actions/cache@v3
        with:
          path: |
            openwrt/dl
            openwrt/staging_dir
            openwrt/build_dir
            openwrt/.config
          key: openwrt-24.10.4-base-${{ runner.os }}-${{ github.sha }}

      - name: 编译软路由基础固件
        run: |
          cd openwrt
          make -j$(nproc) || make -j1 V=s  # 多核编译，失败则单核调试

      - name: 上传编译好的基础固件
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-24.10.4-base-x86_64
          path: openwrt/bin/targets/x86/64/*.img.gz
          retention-days: 30  # 固件保留30天，方便下载
